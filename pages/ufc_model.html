<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UFC Analysis Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.min.css" rel="stylesheet">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W37NSMXN3X"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-W37NSMXN3X');
    </script>

    <style>
        @font-face {
            font-family: 'Berthold Akzidenz Grotesk';
            src: url('../assets/BERTHOLD AKZIDENZ GROTESK BOLD CONDENSED.OTF') format('opentype');
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #222222;
            color: #ffffff;
        }

        body {
            font-family: 'Berthold Akzidenz Grotesk', Arial, sans-serif;
            display: flex;
            flex-direction: row;
        }

        .container {
            display: flex;
            flex-direction: column;
            width: 250px;
            padding: 10px;
            box-sizing: border-box;
            background-color: #333333;
            color: #ffffff;
        }

        h1 {
            text-align: center;
            margin: 0;
            padding-bottom: 10px;
            font-size: 20px;
            color: #ffffff;
        }

        .dropdowns {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }

        label {
            margin-bottom: 3px;
            font-size: 12px;
            color: #ffffff;
        }

        .fighter-dropdown,
        .metric-dropdown {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #555555;
            font-size: 14px;
            width: 100%;
            margin-bottom: 8px;
            font-family: 'Berthold Akzidenz Grotesk', Arial, sans-serif;
            background-color: #222222;
            color: #ffffff;
        }

        button {
            padding: 8px 0;
            border: none;
            border-radius: 4px;
            background-color: rgb(188,161,88);
            color: #ffffff;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 8px;
            font-family: 'Berthold Akzidenz Grotesk', Arial, sans-serif;
            transition: background-color 0.3s ease;
        }

        button.active {
            background-color: rgb(140,113,42);
            color: #ffffff;
        }

        button:hover {
            background-color: rgb(160,133,62);
        }

        .charts-wrapper {
            flex-grow: 1;
            display: flex;
            width: calc(100% - 250px);
            height: 100%;
            overflow: hidden;
            padding-left: 10px;
            background-color: #222222;
        }

        .chart-container {
            flex: 1;
            position: relative;
            min-height: 0;
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
            display: block;
            background-color: #222222;
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
            margin-top: 5px;
        }

        .slider-group {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .slider-group label {
            width: 40px;
            font-size: 12px;
            margin-right: 5px;
            color: #ffffff;
        }

        .slider-group .slider {
            flex-grow: 1;
        }

        .slider-group span {
            width: 25px;
            text-align: right;
            margin-left: 5px;
            font-size: 12px;
            color: #ffffff;
        }

        .maximized {
            flex: 1 1 100%;
        }

        .minimized {
            flex: 0;
        }

        @media (max-aspect-ratio: 3/4) {
            body {
                flex-direction: column;
                overflow-y: auto;
            }

            h1 {
                font-size: 16px;
                text-align: center;
                margin-bottom: 10px;
                width: 100%;
                color: #ffffff;
            }

            .container {
                width: 100%;
                padding: 5px;
                display: flex;
                flex-direction: column;
                align-items: center;
                background-color: #333333;
            }

            .form-wrapper {
                display: flex;
                justify-content: space-between;
                width: 100%;
                max-width: 900px;
                gap: 5px;
            }

            .left-column, .middle-column, .right-column {
                display: flex;
                flex-direction: column;
                justify-content: space-around;
                height: 100%;
            }

            .left-column, .middle-column {
                width: 45%;
            }

            .right-column {
                width: 20%;
            }

            .dropdowns > div, .slider-group, .buttons > button {
                margin-bottom: 10px;
                flex-grow: 1;
            }

            .fighter-dropdown,
            .metric-dropdown,
            button {
                font-size: 12px;
                padding: 4px 8px;
            }

            .slider-group {
                display: flex;
                align-items: center;
                width: 100%;
            }

            .slider-group label {
                font-size: 10px;
                width: 20%;
                margin-right: 5px;
                color: #ffffff;
            }

            .slider-group .slider {
                flex-grow: 1;
                margin-right: 5px;
            }

            .slider-group span {
                font-size: 10px;
                width: 15%;
                text-align: right;
                color: #ffffff;
            }

            .charts-wrapper {
                flex-direction: column;
                width: 100%;
                height: auto;
                padding-left: 0;
                margin-top: 15px;
            }

            .chart-container {
                width: 100%;
                height: 45vh;
                margin-bottom: 10px;
            }

            canvas {
                height: 100% !important;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>UFC Analysis Dashboard</h1>
    
        <div class="form-wrapper">
            <div class="left-column">
                <div class="dropdowns">
                    <div>
                        <label for="fighter1">Fighter 1:</label>
                        <select id="fighter1" class="fighter-dropdown"></select>
                    </div>
                    <div>
                        <label for="fighter2">Fighter 2:</label>
                        <select id="fighter2" class="fighter-dropdown"></select>
                    </div>
                    <div>
                        <label for="metric">Metric:</label>
                        <select id="metric" class="metric-dropdown"></select>
                    </div>
                </div>
            </div>
    
            <div class="middle-column">
                <div class="slider-container">
                    <div class="slider-group">
                        <label for="yearSlider">Year:</label>
                        <input type="range" id="yearSlider" min="2000" max="2024" value="2024" class="slider">
                        <span id="yearValue">2024</span>
                    </div>
                    <div class="slider-group">
                        <label for="monthSlider">Month:</label>
                        <input type="range" id="monthSlider" min="1" max="12" value="12" class="slider">
                        <span id="monthValue">12</span>
                    </div>
                    <div class="slider-group">
                        <label for="daySlider">Day:</label>
                        <input type="range" id="daySlider" min="1" max="31" value="31" class="slider">
                        <span id="dayValue">31</span>
                    </div>
                </div>
            </div>
    
            <div class="right-column">
                <div class="buttons">
                    <button id="plotBtn">Plot Metrics</button>
                    <button id="printBtn">Print to Clipboard</button>
                    <button id="maximizeRadarBtn">Maximize Radar Plot</button>
                    <button id="maximizeLineBtn">Maximize Line Plot</button>        
                </div>
            </div>
        </div>
    </div>    
    
    <div class="charts-wrapper">
        <!-- Radar Chart -->
        <div class="chart-container">
            <canvas id="radarPlot"></canvas>
        </div>
    
        <!-- Line Chart -->
        <div class="chart-container">
            <canvas id="plot"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.8.7/chosen.jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        
        function populateDropdowns(data) {
            const fighters = new Set();
            const metrics = new Set();

            data.forEach(row => {
                const redFighter = row['Red Fighter'] ? row['Red Fighter'].trim() : null;
                const blueFighter = row['Blue Fighter'] ? row['Blue Fighter'].trim() : null;

                if (redFighter) fighters.add(redFighter);
                if (blueFighter) fighters.add(blueFighter);

                Object.keys(row).forEach(key => {
                    if (key.endsWith('Post')) {
                        const baseMetric = key.replace(/^(Red|Blue) /, '').replace('Post', '').trim();
                        metrics.add(baseMetric);
                    }
                });
            });

            const uniqueFighters = Array.from(fighters).sort();
            const uniqueMetrics = Array.from(metrics).sort();

            const fighterDropdowns = document.querySelectorAll('.fighter-dropdown');
            fighterDropdowns.forEach(dropdown => {
                dropdown.innerHTML = '';
                uniqueFighters.forEach(fighter => {
                    const option = document.createElement('option');
                    option.value = fighter;
                    option.textContent = fighter;
                    dropdown.appendChild(option);
                });
            });

            const metricDropdown = document.getElementById('metric');
            metricDropdown.innerHTML = '';
            uniqueMetrics.forEach(metric => {
                const option = document.createElement('option');
                option.value = metric;
                option.textContent = metric;
                metricDropdown.appendChild(option);
            });

            const defaultFighter1 = 'Conor McGregor';
            const defaultFighter2 = 'Khabib Nurmagomedov';
            const defaultMetric = 'ELO';

            document.getElementById('fighter1').value = defaultFighter1;
            document.getElementById('fighter2').value = defaultFighter2;
            document.getElementById('metric').value = defaultMetric;

            $('#fighter1, #fighter2, #metric').chosen({
                width: '100%'
            }).trigger('chosen:updated').css({
                'background-color': '#333333',
                'color': '#ffffff'
            });
        }

        function plotMetrics(fighter1, fighter2, metric, data) {
            const metricWithPost = metric + ' Post';

            let valuesFighter1 = [0];
            let valuesFighter2 = [0];

            if (metric.startsWith('ELO')) {
                valuesFighter1 = [400];
                valuesFighter2 = [400];
            }
            const labels = [0];

            const radarMetrics = [
                'ELO (Ctrl Time)',
                'ELO (TD Off)',
                'ELO (KD)',
                'ELO (Str Clch Off)',
                'ELO (Str Dist Off)',
                'ELO (Str Grnd Off)'
            ];

            const radarLabels = [
                'Control',
                'Wrestling',
                'Power',
                'Clinch',
                'Stand-Up',
                'Ground & Pound'
            ];

            let radarDataFighter1 = [];
            let radarDataFighter2 = [];

            let maxFights = 0;

            const selectedYear  = document.getElementById('yearSlider').value;
            const selectedMonth = document.getElementById('monthSlider').value;
            const selectedDay   = document.getElementById('daySlider').value;
            const selectedDate  = new Date(`${selectedYear}-${selectedMonth}-${selectedDay}`);

            let fighter1Data = [];
            let fighter2Data = [];

            data.forEach(row => {
                const fightDate = new Date(row['Date']);
                if (fightDate <= selectedDate) {
                    if (row['Red Fighter'] === fighter1 || row['Blue Fighter'] === fighter1) {
                        fighter1Data.push(row);
                    }
                    if (row['Red Fighter'] === fighter2 || row['Blue Fighter'] === fighter2) {
                        fighter2Data.push(row);
                    }
                }
            });

            radarMetrics.forEach(metric => {
                const metricFighter1 = fighter1Data.slice(-6).map(row => {
                    if (row['Red Fighter'] === fighter1) {
                        return parseFloat(row[`Red ${metric} Post`] || 0);
                    } else {
                        return parseFloat(row[`Blue ${metric} Post`] || 0);
                    }
                });
                radarDataFighter1.push(metricFighter1.slice(-1)[0]);
            });

            radarMetrics.forEach(metric => {
                const metricFighter2 = fighter2Data.slice(-6).map(row => {
                    if (row['Red Fighter'] === fighter2) {
                        return parseFloat(row[`Red ${metric} Post`] || 0);
                    } else {
                        return parseFloat(row[`Blue ${metric} Post`] || 0);
                    }
                });
                radarDataFighter2.push(metricFighter2.slice(-1)[0]);
            });

            let fightNumber = 1;
            fighter1Data.forEach(row => {
                const isFighter1Red = row['Red Fighter'] === fighter1;
                const isFighter1Blue = row['Blue Fighter'] === fighter1;

                if (isFighter1Red || isFighter1Blue) {
                    labels.push(fightNumber);
                    if (isFighter1Red) {
                        valuesFighter1.push(parseFloat(row[`Red ${metricWithPost}`] || 0));
                    } else if (isFighter1Blue) {
                        valuesFighter1.push(parseFloat(row[`Blue ${metricWithPost}`] || 0));
                    }
                    fightNumber++;
                }
            });

            maxFights = fightNumber - 1;

            fightNumber = 1;
            fighter2Data.forEach(row => {
                const isFighter2Red = row['Red Fighter'] === fighter2;
                const isFighter2Blue = row['Blue Fighter'] === fighter2;

                if (isFighter2Red || isFighter2Blue) {
                    if (isFighter2Red) {
                        valuesFighter2.push(parseFloat(row[`Red ${metricWithPost}`] || 0));
                    } else if (isFighter2Blue) {
                        valuesFighter2.push(parseFloat(row[`Blue ${metricWithPost}`] || 0));
                    }
                    fightNumber++;
                }
            });

            maxFights = Math.max(maxFights, fightNumber - 1);

            for (let i = labels.length + 1; i <= maxFights; i++) {
                labels.push(i);
            }
            
            const ctx = document.getElementById('plot').getContext('2d');
            if (window.myChart) {
                window.myChart.destroy();
            }

            const textPlugin = {
                id: 'textPlugin',
                beforeDraw: (chart) => {
                    const { ctx, chartArea: { left, right, top, bottom, width, height } } = chart;

                    ctx.save();

                    const fontSize = Math.min(width, height) * 0.15;
                    ctx.font = `${fontSize}px "Berthold Akzidenz Grotesk", Arial, sans-serif`;
                    ctx.fillStyle = 'rgba(255,255,255,0.1)';

                    const line1 = "@TheAidenWagner";
                    const line2 = "opendyna.com";

                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    const x = left + width / 2;
                    const y1 = top + height / 2 - 40;
                    const y2 = top + height / 2 + 40;

                    ctx.fillText(line1, x, y1);
                    ctx.fillText(line2, x, y2);

                    ctx.restore();
                }
            };

            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: `${fighter1}`,
                            data: valuesFighter1,
                            backgroundColor: 'rgba(220, 20, 60,0.2)',
                            borderColor: 'rgba(220, 20, 60,1.0)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: 'rgba(220, 20, 60,1.0)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 1,
                            fill: true
                        },
                        {
                            label: `${fighter2}`,
                            data: valuesFighter2,
                            backgroundColor: 'rgb(65, 105, 225,0.2)',
                            borderColor: 'rgb(65, 105, 225,1.0)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: 'rgb(65, 105, 225,1.0)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 1,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            min: 0,
                            title: {
                                display: true,
                                text: 'Fight Number',
                                color: '#ffffff',
                                font: {
                                    family: 'Berthold Akzidenz Grotesk',
                                    size: 18
                                }
                            },
                            ticks: {
                                color: '#ffffff',
                                font: {
                                    family: 'Berthold Akzidenz Grotesk',
                                    size: 16
                                },
                                stepSize: 1,
                                beginAtZero: true,
                                max: maxFights
                            },
                            grid: {
                                color: '#888888'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: `${metric}`,
                                color: '#ffffff',
                                font: {
                                    family: 'Berthold Akzidenz Grotesk',
                                    size: 18
                                }
                            },
                            ticks: {
                                color: '#ffffff',
                                font: {
                                    family: 'Berthold Akzidenz Grotesk',
                                    size: 16
                                }
                            },
                            grid: {
                                color: '#888888'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff',
                                font: {
                                    family: 'Berthold Akzidenz Grotesk',
                                    size: 16
                                }
                            }
                        },
                        chartAreaBackground: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        }
                    }
                },
                plugins: [{
                    id: 'chartAreaBackground',
                    beforeDraw: (chart) => {
                        const ctx = chart.ctx;
                        const chartArea = chart.chartArea;
                        ctx.save();
                        ctx.fillStyle = chart.options.plugins.chartAreaBackground.color || 'black';
                        ctx.fillRect(chartArea.left, chartArea.top, chartArea.right - chartArea.left, chartArea.bottom - chartArea.top);
                        ctx.restore();
                    }
                },textPlugin]
            });

            const radarCtx = document.getElementById('radarPlot').getContext('2d');
            if (window.myRadarChart) {
                window.myRadarChart.destroy();
            }
            
            const textPluginRadar = {
                id: 'textPlugin',
                beforeDraw: (chart) => {
                    const { ctx, chartArea: { width, height }, scales: { r } } = chart;

                    ctx.save();

                    const fontSize = Math.min(width, height) * 0.075;
                    ctx.font = `${fontSize}px "Berthold Akzidenz Grotesk", Arial, sans-serif`;
                    ctx.fillStyle = 'rgba(255,255,255,0.1)';

                    const line1 = "@TheAidenWagner";
                    const line2 = "opendyna.com";

                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    const x = r.xCenter;
                    const y1 = r.yCenter - 30;
                    const y2 = r.yCenter + 30;

                    ctx.fillText(line1, x, y1);
                    ctx.fillText(line2, x, y2);

                    ctx.restore();
                }
            };

            window.myRadarChart = new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: radarLabels,
                    datasets: [
                        {
                            label: `${fighter1}`,
                            data: radarDataFighter1,
                            backgroundColor: 'rgba(220, 20, 60,0.2)',
                            borderColor: 'rgba(220, 20, 60,1.0)',
                            pointRadius: 6,
                            pointBackgroundColor: 'rgba(220, 20, 60,1.0)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(255, 0, 0, 1)'
                        },
                        {
                            label: `${fighter2}`,
                            data: radarDataFighter2,
                            backgroundColor: 'rgb(65, 105, 225,0.2)',
                            borderColor: 'rgb(65, 105, 225,1.0)',
                            pointRadius: 6,
                            pointBackgroundColor: 'rgb(65, 105, 225,1.0)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(0, 0, 255, 1)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0,
                            backgroundColor: 'rgba(255, 255, 255, 0.05)',
                            grid:{
                                color: '#444444'
                            },
                            angleLines: {
                                color: '#888888'
                            },
                            pointLabels: {
                                color: '#ffffff',
                                font: {
                                    family: 'Berthold Akzidenz Grotesk',
                                    size: 18
                                }
                            },
                            ticks: {
                                backdropColor: 'rgba(0, 0, 0, 0)',
                                color: '#ffffff',
                                font: {
                                    family: 'Berthold Akzidenz Grotesk',
                                    size: 16
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff',
                                font: {
                                    family: 'Berthold Akzidenz Grotesk',
                                    size: 16
                                }
                            }
                        }
                    }
                },
                plugins: [textPluginRadar]
            });
        }

        async function copyChartsToClipboard() {
            const radarCanvas = document.getElementById('radarPlot');
            const lineCanvas = document.getElementById('plot');

            const combinedCanvas = document.createElement('canvas');
            const ctx = combinedCanvas.getContext('2d');

            combinedCanvas.width = radarCanvas.width + lineCanvas.width;
            combinedCanvas.height = Math.max(radarCanvas.height, lineCanvas.height);

            ctx.drawImage(radarCanvas, 0, 0);
            ctx.drawImage(lineCanvas, radarCanvas.width, 0);

            try {
                const blob = await new Promise((resolve) => combinedCanvas.toBlob(resolve));
                const item = new ClipboardItem({ 'image/png': blob });
                await navigator.clipboard.write([item]);
                console.log('Image copied to clipboard');
            } catch (error) {
                console.error('Failed to copy image to clipboard, downloading instead...', error);

                const dataUrl = combinedCanvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = 'combined_chart.png';
                link.click();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const csvFilePath = '../data/dat.dat';
            Papa.parse(csvFilePath, {
                download: true,
                header: true,
                complete: function(results) {
                    const data = results.data;
                    populateDropdowns(data);

                    document.getElementById('plotBtn').addEventListener('click', () => {
                        const fighter1 = document.getElementById('fighter1').value;
                        const fighter2 = document.getElementById('fighter2').value;
                        const metric = document.getElementById('metric').value;

                        plotMetrics(fighter1, fighter2, metric, data);
                    });

                    document.getElementById('printBtn').addEventListener('click', () => {
                        copyChartsToClipboard();
                    });
                }
            });
        });

        document.getElementById('yearSlider').addEventListener('input', function() {
            document.getElementById('yearValue').textContent = this.value;
        });

        document.getElementById('monthSlider').addEventListener('input', function() {
            document.getElementById('monthValue').textContent = this.value;
        });

        document.getElementById('daySlider').addEventListener('input', function() {
            document.getElementById('dayValue').textContent = this.value;
        });

        document.getElementById('maximizeRadarBtn').addEventListener('click', function() {
            const radarContainer = document.querySelector('.chart-container:first-child');
            const lineContainer = document.querySelector('.chart-container:last-child');
            const btn = this;

            // Toggle maximized for radar and minimized for line
            if (radarContainer.classList.contains('maximized')) {
                radarContainer.classList.remove('maximized');
                lineContainer.classList.remove('minimized');
                btn.classList.remove('active');
                btn.textContent = 'Maximize Radar Plot';
            } else {
                radarContainer.classList.add('maximized');
                lineContainer.classList.add('minimized');
                btn.classList.add('active');
                btn.textContent = 'Restore Plots';
                document.getElementById('maximizeLineBtn').classList.remove('active');
                document.getElementById('maximizeLineBtn').textContent = 'Maximize Line Plot';
            }
        });

        document.getElementById('maximizeLineBtn').addEventListener('click', function() {
            const radarContainer = document.querySelector('.chart-container:first-child');
            const lineContainer = document.querySelector('.chart-container:last-child');
            const btn = this;
            
            if (lineContainer.classList.contains('maximized')) {
                lineContainer.classList.remove('maximized');
                radarContainer.classList.remove('minimized');
                btn.classList.remove('active');
                btn.textContent = 'Maximize Line Plot';
            } else {
                lineContainer.classList.add('maximized');
                radarContainer.classList.add('minimized');
                btn.classList.add('active');
                btn.textContent = 'Restore Plots';
                document.getElementById('maximizeRadarBtn').classList.remove('active');
                document.getElementById('maximizeRadarBtn').textContent = 'Maximize Radar Plot';
            }
        });

    </script>
</body>
</html>
