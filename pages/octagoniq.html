<!DOCTYPE html>
<html>
<head>
    <link rel="icon" type="image/png" sizes="64x64" href="../OD_Logo_64x64.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W37NSMXN3X"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dom-to-image-more@2.9.1/dist/dom-to-image-more.min.js"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-W37NSMXN3X');
    </script>
    <title>OcatagonIQ</title>
    <style>

        @font-face {
            font-family: 'Berthold Akzidenz Grotesk';
            src: url('../assets/BERTHOLD AKZIDENZ GROTESK BOLD CONDENSED.OTF') format('opentype');
        }

        body, html {
            font-family: 'Berthold Akzidenz Grotesk', Arial, sans-serif;
            background-color: rgba(30,30,30,1);
            margin: 0;
            padding: 0;
            height: 100%;
        }

        .container {
            display: flex;
            min-height: 100vh;
            flex-direction: row;
        }

        .control-panel {
            background-color: rgba(50, 50, 50, 1);
            width: 300px;
            min-width: 300px;
            max-width: 300px;
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        button {
            padding: 8px;
            border: none;
            border-radius: 8px;
            background-color: rgb(188,161,88);
            color: #ffffff;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            margin-top: 8px;
            font-family: 'Berthold Akzidenz Grotesk', Arial, sans-serif;
            transition: background-color 0.3s ease;
        }

        .grid-container {
            width: 100vw;
            height: 100vh;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 10px;
            padding: 10px;
        }

        .grid-item {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            grid-column: auto;
            grid-row: auto;
            min-width: 0;
            min-height: 0;
            overflow: hidden;
        }

        .grid-item:nth-child(1) {
            background-color: rgba(30,30,30,1);
            color: white;
        }

        .grid-item:nth-child(2) {
            background-color: rgba(50, 50, 50, 1);
            color: white;
        }

        .grid-item:nth-child(3) {
            background-color: rgba(50, 50, 50, 1);
            color: white;
        }

        .grid-item:nth-child(4) {
            background-color: rgba(50, 50, 50, 1);
            color: white;
        }

        #div2, #div3, #div4 {
            border-radius: 20px;
            overflow: hidden;
        }

        .hidden {
            display: none;
        }

        .full-width {
            grid-column: 1 / span 2;
            grid-row: 1 / span 2;
        }

        .grid-item canvas {
            width: 100%;
            height: auto;
            max-width: 100%;
            max-height: 100%;
            display: block;
            object-fit: contain;
        }

        .grid-item.full-width .info-table td {
            font-size: 32px;
        }

        .grid-item.full-width .stat-table td {
            font-size: 40px;
        }

        .dropdown {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .dropbtn {
            padding: 10px;
            font-size: 16px;
            background-color: rgba(50, 50, 50, 1);
            color: white;
            border: 1px solid rgba(100, 100, 100, 1);
            border-radius: 5px;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-family: 'Berthold Akzidenz Grotesk', Arial, sans-serif;
            box-sizing: border-box;
        }

        .dropbtn:after {
            content: '\25BC';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: rgba(50, 50, 50, 1);
            min-width: 100%;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
            border-radius: 5px;
            border: 1px solid rgba(100, 100, 100, 1);
        }

        .dropdown-content input {
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
            margin-bottom: 12px;
            border: none;
            background-color: rgba(30,30,30,1);
            color: white;
        }

        .dropdown-content a {
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            color: white;
            background-color: rgba(40, 40, 40, 1);
            transition: background-color 0.3s ease;
        }

        .dropdown-content a:hover {
            background-color: rgba(70, 70, 70, 1);
        }

        .show {
            display: block;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        .top-left-container {
            display: flex;
            height: 100%;
            width: 100%;
            align-items: stretch;
        }

        .side-image {
            height: auto;
            max-height: 100%;
            min-height: 100%;
            object-fit: contain;
            margin: auto 0;
            padding: 0px 7px;
        }

        .left-image {
            transform: scaleX(-1);
        }

        .table-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0px 0px;
        }

        .table-wrapper {
            width: 100%;
            height: 100%;
            border-radius: 20px;
            overflow: hidden;
            background-color: rgba(50, 50, 50, 1);
        }

        .info-table {
            width: 100%;
            height: 100%;
            border-collapse: collapse;
            background-color: rgba(50, 50, 50, 1);
            table-layout: fixed;
        }

        .info-table td {
            color: white;
            border-bottom: 1px solid rgba(100, 100, 100, 0.3);
            word-wrap: break-word;
            position: relative;
            text-align: center;
        }

        .info-table tr:last-child td {
            border-bottom: none;
        }

        .info-table tr td:not(:last-child)::after {
            content: "";
            position: absolute;
            top: 25%;
            right: 0;
            width: 1px;
            height: 50%;
            background-color: rgba(100, 100, 100, 0.3);
        }

        .info-table tr:hover td {
            background-color: rgba(70, 70, 70, 1);
        }

        .stat-table {
            width: 100%;
            height: 100%;
            border-collapse: collapse;
            background-color: rgba(50, 50, 50, 1);
            table-layout: fixed;
        }

        .stat-table td {
            color: white;
            border-bottom: 1px solid rgba(100, 100, 100, 0.3);
            word-wrap: break-word;
            position: relative;
            line-height: 1;
            padding: 4px 8px;
        }

        .stat-table tr:not(:first-child) td:nth-child(3) {
            border-right: 4px solid rgba(100, 100, 100, 1);
        }

        .stat-table tr:last-child td {
            border-bottom: none;
        }

        .stat-table tr td:not(:last-child)::after {
            content: "";
            position: absolute;
            top: 25%;
            right: 0;
            width: 1px;
            height: 50%;
            background-color: rgba(100, 100, 100, 0.3);
        }

        .stat-table tr:hover td {
            background-color: rgba(70, 70, 70, 1);
        }

        .neutral-column {
            text-align: center;
            padding-right: 0px;
            font-size: 16px;

        }

        .red-column {
            text-align: right;
            padding-right: 8px;
            font-size: 16px;

        }

        .blue-column {
            text-align: left;
            padding-left: 8px;
            font-size: 16px;
        }

        .thick-divider td {
            border-bottom: 4px solid rgba(100, 100, 100, 1);
        }

        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(30, 30, 30, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-family: 'Berthold Akzidenz Grotesk', Arial, sans-serif;
            font-size: 18px;
        }

        .spinner {
            border: 8px solid rgba(255, 255, 255, 0.2);
            border-top: 8px solid rgba(255, 255, 255, 1);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #333333;
            margin: 5% auto;
            padding: 20px;
            border: none;
            width: 40%;
            color: #ffffff;
            border-radius: 10px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }

        #leaderboardTable {
            width: 100%;
            border-collapse: collapse;
            color: white;
            text-align: left;
        }

        #leaderboardTable th,
        #leaderboardTable td {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        #leaderboardTable th {
            background-color: rgba(50, 50, 50, 0.8);
        }

        /* Mobile styles */
        @media (max-aspect-ratio: 1/1) {

            .control-panel label[for="metric"],
            #metric,
            #cycleBtn {
                display: none;
            }

            .container {
                flex-direction: column;
                height: auto;
            }

            .control-panel {
                width: 100%;
                padding-bottom: 20px;
                min-width: none;
                max-width: none;
            }

            .grid-container {
                display: grid;
                grid-template-columns: 1fr;
                grid-auto-rows: 1fr;
                grid-template-areas: 
                    "div3"
                    "div4"
                    "div1"
                    "div2";
                gap: 0;
                overflow-y: auto;
                height: auto;
                gap: 10px; /* Space between individual grid items */
                padding: 10px; /* Padding around the entire grid container */
            }

            .grid-item {
                width: 100%;
                aspect-ratio: 1 / 1;
            }

            .grid-item:nth-child(1) {
                grid-area: div1;
            }

            .grid-item:nth-child(2) {
                grid-area: div2;
            }

            .grid-item:nth-child(3) {
                grid-area: div3;
            }

            .grid-item:nth-child(4) {
                grid-area: div4;
            }

            body, html {
                font-size: 24px;
            }

            h1, h2, h3, h4, h5, h6 {
                font-size: 1.5em;
            }

            button {
                font-size: 14px;
            }

            .info-table td, .stat-table td {
                font-size: 24px;
            }

            .side-image {
                display: none;
                /*height: 100%;*/
                /*width: auto;*/
                /*max-width: 30%;*/
                /*object-fit: contain;*/
            }

            .control-panel {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto auto;
                grid-gap: 10px;
                align-items: center;
                font-size: 36px;
            }

            .control-panel label:nth-of-type(1) {
                grid-column: 1;
                grid-row: 1;
                text-align: center;
            }

            .control-panel label:nth-of-type(2) {
                grid-column: 2;
                grid-row: 1;
                text-align: center;
            }

            .control-panel .dropdown:nth-of-type(1) {
                grid-column: 1;
                grid-row: 2;
            }

            .control-panel .dropdown:nth-of-type(2) {
                grid-column: 2;
                grid-row: 2;
            }

            .dropbtn {
                font-size: 36px;
                text-align: center;
                padding: 10px;
            }

            .dropdown-content a {
                font-size: 36px;
                text-align: center;
            }

            .dropdown-content input {
                font-size: 36px;
                text-align: center;
            }

            #captureButton {
                display: none;
            }

            #downloadButton {
                display: none;
            }

            #prevFightBtn {
                display: none;  
            }

            #nextFightBtn {
                display: none;  
            }

            #nextEventBtn {
                grid-column: 1 / span 1;
                grid-row: 3;
                text-align: center;
                font-size: 36px;
            }

            #showLeaderboardBtn {
                grid-column: 2 / span 1;
                grid-row: 3;
                text-align: center;
                font-size: 36px;
            }

            .modal-content {
                width: 90%;
                max-height: 90vh;
                margin: 5%;
                padding: 10px;
                border-radius: 20px;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
            }

            .modal-content p {
                text-align: center;
                font-size: 36px;
            }

            .modal-content button {
                font-size: 32px;
            }

            .stat-table td {
                font-size: 20px;
            }

        }

    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="spinner"></div>
        <p>Loading, please wait...</p>
    </div>
    <div id="copyNotification" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.8); color: white; padding: 10px 20px; border-radius: 5px; font-family: Arial, sans-serif; font-size: 14px; z-index: 9999; opacity: 0; transition: opacity 0.5s ease;"></div>
    <div class="container">
        <div class="control-panel">
            <label>Red Fighter:</label>
            <div class="dropdown">
                <div onclick="toggleDropdown('fighter1')" class="dropbtn" id="redDropbtn"></div>
                <div id="fighter1" class="dropdown-content">
                    <input type="text" id="searchInput1" onkeyup="filterFunction('fighter1', 'searchInput1')" placeholder="Search for options...">
                </div>
            </div>
            <label>Blue Fighter:</label>
            <div class="dropdown">
                <div onclick="toggleDropdown('fighter2')" class="dropbtn" id="blueDropbtn"></div>
                <div id="fighter2" class="dropdown-content">
                    <input type="text" id="searchInput2" onkeyup="filterFunction('fighter2', 'searchInput2')" placeholder="Search for options...">
                </div>
            </div>
            <button id="nextEventBtn">Upcoming Bouts</button>
            <div style="display:flex; gap:15px;">
                <button id="prevFightBtn">← Prev Fight</button>
                <button id="nextFightBtn">Next Fight →</button>
            </div>
            <label for="metric">Metric:</label>
            <div id="metric" class="dropdown">
                <div onclick="toggleDropdown('metrics')" class="dropbtn" id="metricDropbtn">ELO</div>
                <div id="metrics" class="dropdown-content">
                    <input type="text" id="searchInput3" onkeyup="filterFunction('metrics', 'searchInput3')" placeholder="Search for options...">
                </div>
            </div>
            <button id="showLeaderboardBtn">Show Leaderboards</button>
            <label for="spacer"></label>
            <label for="spacer"></label>
            <label for="spacer"></label>
            <button id="cycleBtn">Cycle Charts</button>
            <button id="captureButton">Copy to Clipboard</button>
            <button id="downloadButton">Save to Downloads</button>
        </div>
        <div class="grid-container" id="worksheet">
            <div class="grid-item" id="div1">
                <div class="top-left-container">
                    <img src="../data/bodyshots/Unknown_Fighter.png" alt="Image 1" class="side-image left-image" id="redFighterImage">
                    <div class="table-container">
                        <div class="table-wrapper">
                            <table class="info-table">
                                <tbody>
                                    <!-- First Row: Single Column -->
                                    <tr class="single-column-row">
                                        <td colspan="10" class="single-cell">Tale of the Tape</td>
                                    </tr>
                                    <!-- Next 6 Rows: Three Columns -->
                                    <tr class="three-column-row">
                                        <td colspan="4" class="empty-cell right-align" id="redFighterName"></td>
                                        <td colspan="2" class="center-align">Fighter</td>
                                        <td colspan="4" class="empty-cell left-align" id="blueFighterName"></td>
                                    </tr>
                                    <tr class="three-column-row">
                                        <td colspan="4" class="empty-cell right-align" id="redFighterRecord"></td>
                                        <td colspan="2" class="center-align">UFC Record</td>
                                        <td colspan="4" class="empty-cell left-align" id="blueFighterRecord"></td>
                                    </tr>
                                    <tr class="three-column-row">
                                        <td colspan="4" class="empty-cell right-align" id="redFighterAge"></td>
                                        <td colspan="2" class="center-align">Age</td>
                                        <td colspan="4" class="empty-cell left-align" id="blueFighterAge"></td>
                                    </tr>
                                    <tr class="three-column-row">
                                        <td colspan="4" class="empty-cell right-align" id="redFighterHeight"></td>
                                        <td colspan="2" class="center-align">Height</td>
                                        <td colspan="4" class="empty-cell left-align" id="blueFighterHeight"></td>
                                    </tr>
                                    <tr class="three-column-row">
                                        <td colspan="4" class="empty-cell right-align" id="redFighterReach"></td>
                                        <td colspan="2" class="center-align">Reach</td>
                                        <td colspan="4" class="empty-cell left-align" id="blueFighterReach"></td>
                                    </tr>
                                    <tr class="three-column-row">
                                        <td colspan="4" class="empty-cell right-align" id="redFighterStance"></td>
                                        <td colspan="2" class="center-align">Stance</td>
                                        <td colspan="4" class="empty-cell left-align" id="blueFighterStance"></td>
                                    </tr>
                                    <!-- Next 3 Rows: Two Columns -->
                                    <tr class="two-column-row">
                                        <td colspan="5" class="empty-cell right-align" id="redFighterOpponent1"><br><br></td>
                                        <td colspan="5" class="empty-cell left-align" id="blueFighterOpponent1"><br><br></td>
                                    </tr>
                                    <tr class="two-column-row">
                                        <td colspan="5" class="empty-cell right-align" id="redFighterOpponent2"><br><br></td>
                                        <td colspan="5" class="empty-cell left-align" id="blueFighterOpponent2"><br><br></td>
                                    </tr>
                                    <tr class="two-column-row">
                                        <td colspan="5" class="empty-cell right-align" id="redFighterOpponent3"><br><br></td>
                                        <td colspan="5" class="empty-cell left-align" id="blueFighterOpponent3"><br><br></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <img src="../data/bodyshots/Unknown_Fighter.png" alt="Image 2" class="side-image right-image" id="blueFighterImage">
                </div>
            </div>
            <div class="grid-item" id="div2">
                <table class="stat-table">
                    <tbody>
                        <!-- First Row: Single Column -->
                        <tr class="single-column-row">
                            <td colspan="4" class="center-align neutral-column">Stats</td>
                            <td colspan="2" class="center-align neutral-column" id="redFighterName2">Total</td>
                            <td colspan="2" class="center-align neutral-column" id="redFighterName2">Round 1</td>
                            <td colspan="2" class="center-align neutral-column" id="redFighterName2">Round 2</td>
                            <td colspan="2" class="center-align neutral-column" id="redFighterName2">Round 3</td>
                            <td colspan="2" class="center-align neutral-column" id="redFighterName2">Round 4</td>
                            <td colspan="2" class="center-align neutral-column" id="redFighterName2">Round 5</td>
                        </tr>
                        <!-- Next 6 Rows: Three Columns -->
                        <tr class="three-column-row">
                            <td colspan="4" class="center-align neutral-column">Avg. Ctrl Time</td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageControlTime"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageControlTime"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageControlTimeRound1"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageControlTimeRound1"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageControlTimeRound2"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageControlTimeRound2"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageControlTimeRound3"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageControlTimeRound3"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageControlTimeRound4"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageControlTimeRound4"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageControlTimeRound5"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageControlTimeRound5"></td>
                        </tr>
                        <tr class="three-column-row">
                            <td colspan="4" class="center-align neutral-column">Avg. Ctrld Time</td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageControlledTime"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageControlledTime"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageControlledTimeRound1"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageControlledTimeRound1"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageControlledTimeRound2"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageControlledTimeRound2"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageControlledTimeRound3"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageControlledTimeRound3"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageControlledTimeRound4"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageControlledTimeRound4"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageControlledTimeRound5"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageControlledTimeRound5"></td>
                        </tr>
                        <tr class="three-column-row">
                            <td colspan="4" class="center-align neutral-column">Avg. Takedown Vol.</td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageTakedownVolume"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageTakedownVolume"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageTakedownVolumeRound1"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageTakedownVolumeRound1"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageTakedownVolumeRound2"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageTakedownVolumeRound2"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageTakedownVolumeRound3"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageTakedownVolumeRound3"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageTakedownVolumeRound4"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageTakedownVolumeRound4"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageTakedownVolumeRound5"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageTakedownVolumeRound5"></td>
                        </tr>
                        <tr class="three-column-row">
                            <td colspan="4" class="center-align neutral-column">Takedown Acc.</td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageTakedownAccuracy"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageTakedownAccuracy"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageTakedownAccuracyRound1"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageTakedownAccuracyRound1"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageTakedownAccuracyRound2"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageTakedownAccuracyRound2"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageTakedownAccuracyRound3"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageTakedownAccuracyRound3"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageTakedownAccuracyRound4"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageTakedownAccuracyRound4"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageTakedownAccuracyRound5"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageTakedownAccuracyRound5"></td>
                        </tr>
                        <tr class="three-column-row">
                            <td colspan="4" class="center-align neutral-column">Takedown Def.</td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageTakedownDefense"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageTakedownDefense"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageTakedownDefenseRound1"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageTakedownDefenseRound1"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageTakedownDefenseRound2"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageTakedownDefenseRound2"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageTakedownDefenseRound3"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageTakedownDefenseRound3"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageTakedownDefenseRound4"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageTakedownDefenseRound4"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageTakedownDefenseRound5"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageTakedownDefenseRound5"></td>
                        </tr>
                        <tr class="three-column-row">
                            <td colspan="4" class="center-align neutral-column">Avg. Dist. Strike Vol.</td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageDistanceStrikeVolume"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageDistanceStrikeVolume"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageDistanceStrikeVolumeRound1"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageDistanceStrikeVolumeRound1"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageDistanceStrikeVolumeRound2"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageDistanceStrikeVolumeRound2"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageDistanceStrikeVolumeRound3"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageDistanceStrikeVolumeRound3"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageDistanceStrikeVolumeRound4"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageDistanceStrikeVolumeRound4"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageDistanceStrikeVolumeRound5"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageDistanceStrikeVolumeRound5"></td>
                        </tr>
                        <tr class="three-column-row">
                            <td colspan="4" class="center-align neutral-column">Dist. Strike Acc.</td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageDistanceStrikeAccuracy"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageDistanceStrikeAccuracy"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageDistanceStrikeAccuracyRound1"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageDistanceStrikeAccuracyRound1"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageDistanceStrikeAccuracyRound2"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageDistanceStrikeAccuracyRound2"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageDistanceStrikeAccuracyRound3"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageDistanceStrikeAccuracyRound3"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageDistanceStrikeAccuracyRound4"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageDistanceStrikeAccuracyRound4"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageDistanceStrikeAccuracyRound5"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageDistanceStrikeAccuracyRound5"></td>
                        </tr>
                        <tr class="three-column-row thick-divider">
                            <td colspan="4" class="center-align neutral-column">Dist. Strike Def.</td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageDistanceStrikeDefense"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageDistanceStrikeDefense"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageDistanceStrikeDefenseRound1"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageDistanceStrikeDefenseRound1"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageDistanceStrikeDefenseRound2"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageDistanceStrikeDefenseRound2"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageDistanceStrikeDefenseRound3"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageDistanceStrikeDefenseRound3"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageDistanceStrikeDefenseRound4"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageDistanceStrikeDefenseRound4"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterAverageDistanceStrikeDefenseRound5"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterAverageDistanceStrikeDefenseRound5"></td>
                        </tr>
                        <tr class="three-column-row">
                            <td colspan="4" class="center-align neutral-column">Career Knockdowns</td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnockdowns"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnockdowns"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnockdownsRound1"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnockdownsRound1"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnockdownsRound2"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnockdownsRound2"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnockdownsRound3"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnockdownsRound3"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnockdownsRound4"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnockdownsRound4"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnockdownsRound5"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnockdownsRound5"></td>
                        </tr>
                        <tr class="three-column-row">
                            <td colspan="4" class="center-align neutral-column">Career Knockouts</td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnockouts"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnockouts"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnockoutsRound1"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnockoutsRound1"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnockoutsRound2"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnockoutsRound2"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnockoutsRound3"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnockoutsRound3"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnockoutsRound4"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnockoutsRound4"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnockoutsRound5"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnockoutsRound5"></td>
                        </tr>
                        <tr class="three-column-row">
                            <td colspan="4" class="center-align neutral-column">Career Knocked-downs</td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnocked-downs"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnocked-downs"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnocked-downsRound1"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnocked-downsRound1"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnocked-downsRound2"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnocked-downsRound2"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnocked-downsRound3"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnocked-downsRound3"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnocked-downsRound4"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnocked-downsRound4"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnocked-downsRound5"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnocked-downsRound5"></td>
                        </tr>
                        <tr class="three-column-row">
                            <td colspan="4" class="center-align neutral-column">Career Knocked-outs</td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnocked-outs"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnocked-outs"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnocked-outsRound1"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnocked-outsRound1"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnocked-outsRound2"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnocked-outsRound2"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnocked-outsRound3"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnocked-outsRound3"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnocked-outsRound4"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnocked-outsRound4"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerKnocked-outsRound5"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerKnocked-outsRound5"></td>
                        </tr>
                        <tr class="three-column-row">
                            <td colspan="4" class="center-align neutral-column">Career Submissions</td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerSubmissions"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerSubmissions"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerSubmissionsRound1"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerSubmissionsRound1"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerSubmissionsRound2"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerSubmissionsRound2"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerSubmissionsRound3"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerSubmissionsRound3"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerSubmissionsRound4"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerSubmissionsRound4"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerSubmissionsRound5"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerSubmissionsRound5"></td>
                        </tr>
                        <tr class="three-column-row">
                            <td colspan="4" class="center-align neutral-column">Career Submitteds</td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerSubmitteds"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerSubmitteds"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerSubmittedsRound1"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerSubmittedsRound1"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerSubmittedsRound2"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerSubmittedsRound2"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerSubmittedsRound3"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerSubmittedsRound3"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerSubmittedsRound4"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerSubmittedsRound4"></td>
                            <td colspan="1" class="center-align red-column" id= "redFighterCareerSubmittedsRound5"></td>
                            <td colspan="1" class="center-align blue-column" id="blueFighterCareerSubmittedsRound5"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="grid-item" id="div3">
                <canvas id="radarChart"></canvas>
            </div>
            <div class="grid-item" id="div4">
                <canvas id="lineGraph"></canvas>
            </div>
        </div>
    </div>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <p>Select a Bout (UFC Fight Night: Burns vs. Morales):</p>
            <button id="fight1">Gilbert Burns vs. Michael Morales</button>
            <button id="fight2">Rodolfo Bellato vs. Paul Craig</button>
            <button id="fight3">Sodiq Yusuff vs. Mairon Santos</button>
            <button id="fight4">Dustin Stoltzfus vs. Nursulton Ruziboev</button>
            <button id="fight5">Julian Erosa vs. Melquizael Costa</button>
            <button id="fight6">Gabe Green vs. Matheus Camilo</button>
            <button id="fight7">Jared Gordon vs. Thiago Moises</button>
            <button id="fight8">Luana Santos vs. Tainara Lisboa</button>
            <button id="fight9">Elise Reed vs. Denise Gomes</button>
            <button id="fight10">HyunSung Park vs. Carlos Hernandez</button>
            <button id="fight11">Tecia Pennington vs. Luana Pinheiro</button>
            <p>Select a Bout (UFC 315: Muhammad vs. Della Maddalena):</p>
            <button id="fight1">Belal Muhammad vs. Jack Della Maddalena</button>
            <button id="fight2">Valentina Shevchenko vs. Manon Fiorot</button>
            <button id="fight3">Jose Aldo vs. Aiemann Zahabi</button>
            <button id="fight4">Alexa Grasso vs. Natalia Silva</button>
            <button id="fight5">Benoit Saint Denis vs. Joel Alvarez</button>
            <button id="fight6">Mike Malott vs. Charles Radtke</button>
            <button id="fight7">Jessica Andrade vs. Jasmine Jasudavicius</button>
            <button id="fight8">Modestas Bukauskas vs. Ion Cutelaba</button>
            <button id="fight9">Navajo Stirling vs. Ivan Erslan</button>
            <button id="fight10">Marc-Andre Barriault vs. Bruno Silva</button>
            <button id="fight11">Daniel Santos vs. JeongYeong Lee</button>
            <button id="fight12">Brad Katona vs. Bekzat Almakhan</button>
            <button id="cancelButton">Cancel</button>
        </div>
    </div>

    <!-- Modal Structure -->
    <div id="leaderboardModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeLeaderboard">&times;</span>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:20px;">
                <select id="weightClassSelect" style="background-color: rgba(50, 50, 50, 1); color: white; border: 1px solid rgba(100, 100, 100, 1); padding: 10px; font-family: 'Berthold Akzidenz Grotesk', Arial, sans-serif;">
                    <option>Pound-for-Pound</option>
                    <option>Flyweight</option>
                    <option>Bantamweight</option>
                    <option>Featherweight</option>
                    <option>Lightweight</option>
                    <option>Welterweight</option>
                    <option>Middleweight</option>
                    <option>Light Heavyweight</option>
                    <option>Heavyweight</option>
                    <option>Women's Pound-for-Pound</option>
                    <option>Women's Strawweight</option>
                    <option>Women's Flyweight</option>
                    <option>Women's Bantamweight</option>
                </select>
                <label style="color:white; font-family:'Berthold Akzidenz Grotesk', Arial, sans-serif; display:flex; align-items:center;">
                    <input type="checkbox" id="activeFightersCheckbox" style="transform: scale(1.5); margin-right:10px;" checked>
                    Active Fighters Only
                </label>
            </div>
            <h2>LEADERBOARD</h2>
            <table id="leaderboardTable">
                <thead>
                    <tr>
                        <th id="rankHeader">Rank</th>
                        <th id="fighterHeader">Fighter</th>
                        <th id="currentHeader" data-sort="current">Current {metric}</th>
                        <th id="careerMaxHeader" data-sort="careerMax">Career Max {metric}</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Leaderboard rows will be dynamically added here -->
                </tbody>
            </table>
        </div>
    </div>



    <script>

        const cycleBtn = document.getElementById('cycleBtn');
        const div1     = document.getElementById('div1');
        const div2     = document.getElementById('div2');
        const div3     = document.getElementById('div3');
        const div4     = document.getElementById('div4');
        let viewState  = 0;

        let paddedValuesFighter1 = [];
        let paddedValuesFighter2 = [];
        let maxFights = [];

        let data;
        let info;
        let rost;

        let sortColumn = 'current';
        let sortOrder = 'desc';

        const radarCtx = document.getElementById('radarChart').getContext('2d');

        const textPluginRadar = {
            id: 'textPluginRadar',
            beforeDraw: (chart) => {
                const { ctx, chartArea: { width, height }, scales: { r } } = chart;

                ctx.save();

                const fontSize = Math.min(width, height) * 0.25;
                ctx.font = `${fontSize}px "Berthold Akzidenz Grotesk", Arial, sans-serif`;
                ctx.fillStyle = 'rgba(255,255,255,0.03)';

                const line1 = "@TheAidenWagner";
                const line2 = "opendyna.com";

                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                const x = r.xCenter;
                const y1 = r.yCenter - Math.min(width, height)*0.15;
                const y2 = r.yCenter + Math.min(width, height)*0.15;

                ctx.fillText(line1, x, y1);
                ctx.fillText(line2, x, y2);

                ctx.restore();
            }
        };

        if (window.myRadarChart) {
            window.myRadarChart.destroy();
        }
        window.myRadarChart = new Chart(radarCtx, {
            type: 'radar',
            data: {
                labels: ['Control', 'Wrestling', 'Power', 'Clinch', 'Stand-Up', 'Submission', 'Cardio', 'Ground & Pound'],
                datasets: [
                    {
                        label: `${fighter1}`,
                        data: [0, 0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(220, 20, 60,0.2)',
                        borderColor: 'rgba(220, 20, 60,1.0)',
                        pointRadius: 6,
                        pointBackgroundColor: 'rgba(220, 20, 60,1.0)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(255, 0, 0, 1)'
                    },
                    {
                        label: `${fighter2}`,
                        data: [0, 0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: 'rgb(65, 105, 225,0.2)',
                        borderColor: 'rgb(65, 105, 225,1.0)',
                        pointRadius: 6,
                        pointBackgroundColor: 'rgb(65, 105, 225,1.0)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(0, 0, 255, 1)'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        min: 0,
                        backgroundColor: 'rgba(255, 255, 255, 0.05)',
                        grid:{
                            color: '#888888'
                        },
                        angleLines: {
                            color: '#888888'
                        },
                        pointLabels: {
                            color: '#ffffff',
                            font: {
                                family: 'Berthold Akzidenz Grotesk',
                                size: 18
                            }
                        },
                        ticks: {
                            backdropColor: 'rgba(0, 0, 0, 0)',
                            color: '#ffffff',
                            font: {
                                family: 'Berthold Akzidenz Grotesk',
                                size: 16
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#ffffff',
                            font: {
                                family: 'Berthold Akzidenz Grotesk',
                                size: 16
                            }
                        }
                    }
                }
            },
            plugins: [textPluginRadar]
        });

        const lineCtx = document.getElementById('lineGraph').getContext('2d');

        const lineTextPlugin = {
            id: 'lineTextPlugin',
            beforeDraw: (chart) => {
                const { ctx, chartArea: { left, right, top, bottom, width, height } } = chart;

                ctx.save();

                const fontSize = Math.min(width, height) * 0.25;
                ctx.font = `${fontSize}px "Berthold Akzidenz Grotesk", Arial, sans-serif`;
                ctx.fillStyle = 'rgba(255,255,255,0.03)';

                const line1 = "@TheAidenWagner";
                const line2 = "opendyna.com";

                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                const x = left + width / 2;
                const y1 = top + height / 2 - Math.min(width, height) * 0.10;
                const y2 = top + height / 2 + Math.min(width, height) * 0.25;

                ctx.fillText(line1, x, y1);
                ctx.fillText(line2, x, y2);

                ctx.restore();
            }
        };

        const customLegendPlugin = {
            id: 'customLegend',
            afterDraw: (chart) => {
                const { ctx, chartArea: { left, right, top, bottom, width, height } } = chart;
                ctx.save();

                // Set the position for the legend
                const legendX = 92;
                const legendY = height - 40;

                // Text and marker settings
                const fontSize = 14;
                const lineHeight = 25;
                const markerSize = 15;

                // Set font for legend text
                ctx.font = `${fontSize}px 'Berthold Akzidenz Grotesk', Arial, sans-serif`;
                ctx.fillStyle = '#ffffff'; // Legend text color

                // Marker definitions
                const markers = [
                    { shape: 'circle', label: 'Decision', color: 'rgba(200, 0, 200,1.0)' },
                    { shape: 'triangle', label: 'Submission', color: 'rgba(200, 0, 200, 1.0)' },
                    { shape: 'rect', label: 'KO/TKO', color: 'rgba(200, 0, 200,1.0)' },
                ];

                // Calculate the size of the legend box
                const boxPadding = 15;
                const boxWidth = 105;
                const boxHeight = markers.length * lineHeight + boxPadding - 5;

                // Draw the background box
                ctx.fillStyle = 'rgba(50, 50, 50, 0.5)'; // Dark background color for the legend
                ctx.strokeStyle = 'rgba(125, 125, 125, 0.5)'; // Light border color for the legend
                ctx.lineWidth = 2;
                ctx.fillRect(legendX - boxPadding, legendY - boxPadding, boxWidth, boxHeight);
                ctx.strokeRect(legendX - boxPadding, legendY - boxPadding, boxWidth, boxHeight);

                // Draw each marker and its label
                markers.forEach((marker, index) => {
                    const x = legendX;
                    const y = legendY + index * lineHeight;

                    // Draw the shape (circle, triangle, or square)
                    ctx.beginPath();
                    if (marker.shape === 'circle') {
                        ctx.arc(x, y, markerSize / 2, 0, Math.PI * 2);
                    } else if (marker.shape === 'triangle') {
                        ctx.moveTo(x, y - markerSize / 2);
                        ctx.lineTo(x - markerSize / 2, y + markerSize / 2);
                        ctx.lineTo(x + markerSize / 2, y + markerSize / 2);
                        ctx.closePath();
                    } else if (marker.shape === 'rect') {
                        ctx.rect(x - markerSize / 2, y - markerSize / 2, markerSize, markerSize);
                    }

                    ctx.fillStyle = marker.color;
                    ctx.fill();

                    // Draw the label
                    ctx.fillStyle = '#ffffff';
                    ctx.fillText(marker.label, x + markerSize + 10, y + markerSize / 4);
                });

                ctx.restore();
            }
        };

        if (window.myLineChart) {
            window.myLineChart.destroy();
        }
        window.myLineChart = new Chart(lineCtx, {
            type: 'line',
            data: {
                labels: [0],
                datasets: [
                    {
                        label: `${fighter1}`,
                        data: paddedValuesFighter1.map((value, index) => ({ x: index, y: value, opponent: opponentsFighter1[index], event: eventsFighter1[index], date: datesFighter1[index], location: locationsFighter1[index], weight: weightsFighter1[index], referee: refereesFighter1[index], round: roundsFighter1[index], time: timesFighter1[index], method: methodsFighter1[index] })),
                        backgroundColor: 'rgba(220, 20, 60,0.2)',
                        borderColor: 'rgba(220, 20, 60,1.0)',
                        borderWidth: 3,
                        pointRadius: 6,
                        pointBackgroundColor: 'rgba(220, 20, 60,1.0)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1,
                        fill: true,
                        pointStyle: paddedValuesFighter1.map((_, index) => getPointStyle(methodsFighter1[index])),
                        pointRadius: paddedValuesFighter1.map((_, index) => getPointRadius(methodsFighter1[index]))
                    },
                    {
                        label: `${fighter2}`,
                        data: paddedValuesFighter2.map((value, index) => ({ x: index, y: value, opponent: opponentsFighter2[index], event: eventsFighter2[index], date: datesFighter2[index], location: locationsFighter2[index], weight: weightsFighter2[index], referee: refereesFighter2[index], round: roundsFighter2[index], time: timesFighter2[index], method: methodsFighter2[index] })),
                        backgroundColor: 'rgba(65, 105, 225,0.2)',
                        borderColor: 'rgba(65, 105, 225,1.0)',
                        borderWidth: 3,
                        pointRadius: 6,
                        pointBackgroundColor: 'rgba(65, 105, 225,1.0)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1,
                        fill: true,
                        pointStyle: paddedValuesFighter2.map((_, index) => getPointStyle(methodsFighter2[index])),
                        pointRadius: paddedValuesFighter2.map((_, index) => getPointRadius(methodsFighter2[index]))
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'linear',
                        min: 0,
                        title: {
                            display: true,
                            text: 'Fight Number',
                            color: '#ffffff',
                            font: {
                                family: 'Berthold Akzidenz Grotesk',
                                size: 18
                            }
                        },
                        ticks: {
                            color: '#ffffff',
                            font: {
                                family: 'Berthold Akzidenz Grotesk',
                                size: 16
                            },
                            stepSize: 1,
                            beginAtZero: true,
                            max: maxFights
                        },
                        grid: {
                            color: '#888888'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: `${metric}`,
                            color: '#ffffff',
                            font: {
                                family: 'Berthold Akzidenz Grotesk',
                                size: 18
                            }
                        },
                        ticks: {
                            color: '#ffffff',
                            font: {
                                family: 'Berthold Akzidenz Grotesk',
                                size: 16
                            }
                        },
                        grid: {
                            color: '#888888'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#ffffff',
                            font: {
                                family: 'Berthold Akzidenz Grotesk',
                                size: 16
                            }
                        }
                    },
                    chartAreaBackground: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    },
                    tooltip: {
                        bodyFont: {
                            size: 24,
                            family: 'Berthold Akzidenz Grotesk'
                        },
                        callbacks: {
                            label: function(tooltipItem) {
                                const dataset = tooltipItem.dataset;
                                const dataIndex = tooltipItem.dataIndex;
                                const value = dataset.data[dataIndex].y;
                                const opponent = dataset.data[dataIndex].opponent || 'N/A';
                                const event    = dataset.data[dataIndex].event || 'N/A';
                                const date     = dataset.data[dataIndex].date || 'N/A';
                                const location = dataset.data[dataIndex].location || 'N/A';
                                const weight   = dataset.data[dataIndex].weight || 'N/A';
                                const referee  = dataset.data[dataIndex].referee || 'N/A';
                                const round    = dataset.data[dataIndex].round || 'N/A';
                                const time     = dataset.data[dataIndex].time || 'N/A';
                                const method   = dataset.data[dataIndex].method || 'N/A';
                                return [`Value: ${value}`, `Opponent: ${opponent}`, `Event: ${event}`, `Date: ${date}`, `Location: ${location}`, `Weight: ${weight}`, `Referee: ${referee}`, `Result: Round ${round} at ${time} via ${method}`];
                            }
                        }
                    }
                }
            },
            plugins: [{
                id: 'chartAreaBackground',
                beforeDraw: (chart) => {
                    const ctx = chart.ctx;
                    const chartArea = chart.chartArea;
                    ctx.save();
                    ctx.fillStyle = chart.options.plugins.chartAreaBackground.color || 'black';
                    ctx.fillRect(chartArea.left, chartArea.top, chartArea.right - chartArea.left, chartArea.bottom - chartArea.top);
                    ctx.restore();
                }
            },lineTextPlugin,customLegendPlugin]
        });

        document.addEventListener('DOMContentLoaded', () => {
            const loadingScreen = document.getElementById('loading-screen');
            loadingScreen.style.display = 'flex';

            const fightButtons = document.querySelectorAll('#myModal button[id^="fight"]');
            const fights = Array.from(fightButtons).map(button => button.textContent.trim());

            let currentFightIndex = 0;

            function setFight(index) {
                if (index < 0) {
                    index = fights.length - 1;
                } else if (index >= fights.length) {
                    index = 0;
                }

                currentFightIndex = index;
                const fightStr = fights[currentFightIndex];
                const [redFighter, blueFighter] = fightStr.split(' vs. ').map(f => f.trim());

                document.getElementById('redDropbtn').textContent = redFighter;
                document.getElementById('blueDropbtn').textContent = blueFighter;
                updateChart();
            }

            document.getElementById('prevFightBtn').addEventListener('click', () => {
                setFight(currentFightIndex - 1);
            });

            document.getElementById('nextFightBtn').addEventListener('click', () => {
                setFight(currentFightIndex + 1);
            });

            Papa.parse('../data/dat.dat', {
                download: true,
                header: true,
                complete: function(results) {
                    data = results.data;
                    Papa.parse('../data/info.dat', {
                        download: true,
                        header: true,
                        complete: function(results) {
                            info = results.data;
                            Papa.parse('../data/rost.dat', {
                                download: true,
                                complete: function(results) {
                                    rost = new Set(results.data.map(row => row[0].trim()));
                                    populateDropdowns(data);
                                    setInitialFightersFromModal();
                                    updateChart();
                                    loadingScreen.style.display = 'none';
                                    setFight(0);
                                }
                            })
                        }
                    })
                }
            })
        })

        window.onclick = function(event) {
            if (!event.target.matches('.dropbtn') && !event.target.matches('.dropdown-content input')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        cycleBtn.addEventListener('click', () => {

            function resetGrid() {
                [div1, div2, div3, div4].forEach(div => {
                    div.classList.remove('hidden', 'full-width');
                });
            }

            function showOnly(div) {
                [div1, div2, div3, div4].forEach(d => d.classList.add('hidden'));
                div.classList.remove('hidden');
                div.classList.add('full-width');
            }

            viewState = (viewState + 1) % 5; // Cycles through 5 states
            resetGrid(); // Reset grid to default

            switch (viewState) {
                case 1:
                    showOnly(div1);
                    break;
                case 2:
                    showOnly(div2);
                    break;
                case 3:
                    showOnly(div3);
                    break;
                case 4:
                    showOnly(div4);
                    break;
                default:
                    break;
            }
        });

        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const input = dropdown.querySelector('input');
            const options = dropdown.querySelectorAll('a');
            dropdown.classList.toggle("show");
            if (dropdown.classList.contains("show")) {
                input.value = "";
                input.focus();
                dropdown.scrollTop = 0;
                options.forEach(option => {
                    option.style.display = "";
                });
                input.addEventListener('keydown', function handleEnter(event) {
                    if (event.key === "Enter") {
                        event.preventDefault();
                        const firstVisibleOption = Array.from(options).find(option => option.style.display !== "none");

                        if (firstVisibleOption) {
                            firstVisibleOption.click();
                        }
                        dropdown.classList.remove("show");
                        input.removeEventListener('keydown', handleEnter);
                    }
                });
            }
        }

        function updateChart() {
            const fighter1 = document.getElementById('redDropbtn').textContent;
            const fighter2 = document.getElementById('blueDropbtn').textContent;
            const metric   = document.getElementById('metricDropbtn').textContent;
            updateData(fighter1, fighter2, metric, data, info);
        }

        function populateDropdowns(data) {
            const fighters = new Set();
            const metrics = new Set();

            // Extract fighters and metrics from data
            data.forEach(row => {
                const redFighter = row['Red Fighter'] ? row['Red Fighter'].trim() : null;
                const blueFighter = row['Blue Fighter'] ? row['Blue Fighter'].trim() : null;

                if (redFighter) fighters.add(redFighter);
                if (blueFighter) fighters.add(blueFighter);

                Object.keys(row).forEach(key => {
                    if (key.endsWith('Post')) {
                        const baseMetric = key.replace(/^(Red|Blue) /, '').replace('Post', '').trim();
                        metrics.add(baseMetric);
                    }
                });
            });

            const uniqueFighters = Array.from(fighters).sort();

            // Populate Red Fighter dropdown
            const redDropdown = document.getElementById('fighter1');
            const redSearchInput = redDropdown.querySelector('input');
            redDropdown.innerHTML = '';
            redDropdown.appendChild(redSearchInput);

            // Reference to the dropbtn for red fighter
            const redDropbtn = document.getElementById('redDropbtn');

            uniqueFighters.forEach(fighter => {
                const option = document.createElement('a');
                option.href = '#';
                option.textContent = fighter;
                option.addEventListener('click', function() {
                    redDropbtn.textContent = fighter;
                    redDropdown.classList.remove('show');
                    updateChart();
                });
                redDropdown.appendChild(option);
            });

            // Populate Blue Fighter dropdown
            const blueDropdown = document.getElementById('fighter2');
            const blueSearchInput = blueDropdown.querySelector('input');
            blueDropdown.innerHTML = '';
            blueDropdown.appendChild(blueSearchInput);

            // Reference to the dropbtn for blue fighter
            const blueDropbtn = document.getElementById('blueDropbtn');

            uniqueFighters.forEach(fighter => {
                const option = document.createElement('a');
                option.href = '#';
                option.textContent = fighter;
                option.addEventListener('click', function() {
                    blueDropbtn.textContent = fighter;
                    blueDropdown.classList.remove('show');
                    updateChart();
                });
                blueDropdown.appendChild(option);
            });

            // Populate Metric dropdown (if applicable)
            if (window.innerWidth > 768) {
                const uniqueMetrics = Array.from(metrics).sort();

                const metricDropdown = document.getElementById('metrics');
                const metricSearchInput = metricDropdown.querySelector('input');
                metricDropdown.innerHTML = '';
                metricDropdown.appendChild(metricSearchInput);

                // Reference to the dropbtn for metrics
                const metricDropbtn = document.getElementById('metricDropbtn');

                uniqueMetrics.forEach(metric => {
                    const option = document.createElement('a');
                    option.href = '#';
                    option.textContent = metric;
                    option.addEventListener('click', function() {
                        metricDropbtn.textContent = metric;
                        metricDropdown.classList.remove('show');
                        updateChart();
                    });
                    metricDropdown.appendChild(option);
                });
            }
        }

        function filterFunction(dropdownId, inputId) {
            var input, filter, dropdown, items, i;
            input = document.getElementById(inputId);
            filter = input.value.toUpperCase();
            dropdown = document.getElementById(dropdownId);
            items = dropdown.getElementsByTagName("a");

            for (i = 0; i < items.length; i++) {
                let txtValue = items[i].textContent || items[i].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    items[i].style.display = "";
                } else {
                    items[i].style.display = "none";
                }
            }
        }

        function updateData(fighter1, fighter2, metric, data, info) {

            const metricWithPost = metric + ' Post';

            let valuesFighter1    = [0];
            let valuesFighter2    = [0];
            let opponentsFighter1 = [''];
            let opponentsFighter2 = [''];
            let eventsFighter1    = [''];
            let eventsFighter2    = [''];
            let datesFighter1     = [''];
            let datesFighter2     = [''];
            let locationsFighter1 = [''];
            let locationsFighter2 = [''];
            let weightsFighter1   = [''];
            let weightsFighter2   = [''];
            let refereesFighter1  = [''];
            let refereesFighter2  = [''];
            let roundsFighter1    = [''];
            let roundsFighter2    = [''];
            let timesFighter1     = [''];
            let timesFighter2     = [''];
            let methodsFighter1   = [''];
            let methodsFighter2   = [''];

            if (metric.startsWith('ELO')) {
                valuesFighter1 = [400];
                valuesFighter2 = [400];
            }
            const labels = [0];

            const getPointStyle = (method) => {
                if (!method) return 'circle';
                if (method.includes('Decision')) return 'circle';
                if (method.includes('Submission')) return 'triangle';
                if (method.includes('KO') || method.includes('TKO')) return 'rect';
                return 'circle';
            };

            const getPointRadius = (method) => {
                if (!method) return 8;
                if (method.includes('Submission')) return 10;
                if (method.includes('KO') || method.includes('TKO')) return 10;
                return 8;
            };

            const radarMetrics = [
                'ELO (Ctrl Time)',
                'ELO (TD Off)',
                'ELO (KD)',
                'ELO (Str Clch Off)',
                'ELO (Str Dist Off)',
                'ELO (Submission)',
                'ELO (Str Volume)',
                'ELO (Str Grnd Off)',
            ];

            const radarLabels = [
                'Control',
                'Wrestling',
                'Power',
                'Clinch',
                'Stand-Up',
                'Submission',
                'Cardio',
                'Ground & Pound',
            ];

            let radarDataFighter1 = [];
            let radarDataFighter2 = [];

            let maxFights = 0;

            let fighter1Data = [];
            let fighter2Data = [];

            data.forEach(row => {
                if (row['Red Fighter'] === fighter1 || row['Blue Fighter'] === fighter1) {
                    fighter1Data.push(row);
                }
                if (row['Red Fighter'] === fighter2 || row['Blue Fighter'] === fighter2) {
                    fighter2Data.push(row);
                }
            });

            radarMetrics.forEach(metric => {
                const metricFighter1 = fighter1Data.slice(-6).map(row => {
                    if (row['Red Fighter'] === fighter1) {
                        return parseFloat(row[`Red ${metric} Post`] || 0);
                    } else {
                        return parseFloat(row[`Blue ${metric} Post`] || 0);
                    }
                });
                radarDataFighter1.push(metricFighter1.slice(-1)[0]);
            });

            radarMetrics.forEach(metric => {
                const metricFighter2 = fighter2Data.slice(-6).map(row => {
                    if (row['Red Fighter'] === fighter2) {
                        return parseFloat(row[`Red ${metric} Post`] || 0);
                    } else {
                        return parseFloat(row[`Blue ${metric} Post`] || 0);
                    }
                });
                radarDataFighter2.push(metricFighter2.slice(-1)[0]);
            });

            let fightNumber = 1;
            fighter1Data.forEach(row => {
                const isFighter1Red = row['Red Fighter'] === fighter1;
                const isFighter1Blue = row['Blue Fighter'] === fighter1;

                if (isFighter1Red || isFighter1Blue) {
                    labels.push(fightNumber);
                    if (isFighter1Red) {
                        valuesFighter1.push(parseFloat(row[`Red ${metricWithPost}`] || 0));
                        opponentsFighter1.push(row['Blue Fighter']);
                    } else if (isFighter1Blue) {
                        valuesFighter1.push(parseFloat(row[`Blue ${metricWithPost}`] || 0));
                        opponentsFighter1.push(row['Red Fighter']);
                    }
                    eventsFighter1.push(row['Event Name']);
                    datesFighter1.push(row['Date']);
                    locationsFighter1.push(row['Location']);
                    weightsFighter1.push(row['Weight']);
                    refereesFighter1.push(row['Referee']);
                    roundsFighter1.push(row['Round']);
                    timesFighter1.push(row['Time']);
                    methodsFighter1.push(row['Method']);
                    fightNumber++;
                }
            });

            maxFights = fightNumber - 1;

            fightNumber = 1;
            fighter2Data.forEach(row => {
                const isFighter2Red = row['Red Fighter'] === fighter2;
                const isFighter2Blue = row['Blue Fighter'] === fighter2;

                if (isFighter2Red || isFighter2Blue) {
                    if (isFighter2Red) {
                        valuesFighter2.push(parseFloat(row[`Red ${metricWithPost}`] || 0));
                        opponentsFighter2.push(row['Blue Fighter']);
                    } else if (isFighter2Blue) {
                        valuesFighter2.push(parseFloat(row[`Blue ${metricWithPost}`] || 0));
                        opponentsFighter2.push(row['Red Fighter']);
                    }
                    eventsFighter2.push(row['Event Name']);
                    datesFighter2.push(row['Date']);
                    locationsFighter2.push(row['Location']);
                    weightsFighter2.push(row['Weight']);
                    refereesFighter2.push(row['Referee']);
                    roundsFighter2.push(row['Round']);
                    timesFighter2.push(row['Time']);
                    methodsFighter2.push(row['Method']);
                    fightNumber++;
                }
            });

            maxFights = Math.max(maxFights, fightNumber - 1);

            for (let i = labels.length + 1; i <= maxFights; i++) {
                labels.push(i);
            }

            const maxLength = Math.max(valuesFighter1.length, valuesFighter2.length);

            const paddedValuesFighter1 = valuesFighter1.concat(Array(maxLength - valuesFighter1.length).fill(NaN));
            const paddedValuesFighter2 = valuesFighter2.concat(Array(maxLength - valuesFighter2.length).fill(NaN));

            const redFighterInfo  = getFighterInfo(fighter1, info);
            const blueFighterInfo = getFighterInfo(fighter2, info);

            //---Update Tale of the Tape Elements---//
            document.getElementById(`redFighterOpponent1` ).innerHTML   = `<br><br>`;
            document.getElementById(`redFighterOpponent2` ).innerHTML   = `<br><br>`;
            document.getElementById(`redFighterOpponent3` ).innerHTML   = `<br><br>`;
            document.getElementById(`blueFighterOpponent1`).innerHTML   = `<br><br>`;
            document.getElementById(`blueFighterOpponent2`).innerHTML   = `<br><br>`;
            document.getElementById(`blueFighterOpponent3`).innerHTML   = `<br><br>`;
            document.getElementById('redFighterImage'     ).src         = `../data/bodyshots/${fighter1}.png`;
            document.getElementById('redFighterImage'     ).onerror     = function () { this.src = '../data/bodyshots/Unknown_Fighter.png'; };
            document.getElementById('blueFighterImage'    ).src         = `../data/bodyshots/${fighter2}.png`;
            document.getElementById('blueFighterImage'    ).onerror     = function () { this.src = '../data/bodyshots/Unknown_Fighter.png'; };
            document.getElementById('redFighterName'      ).textContent = fighter1;
            document.getElementById('blueFighterName'     ).textContent = fighter2;
            document.getElementById('redFighterRecord'    ).innerHTML   = calculateFighterRecord(fighter1, data);
            document.getElementById('blueFighterRecord'   ).innerHTML   = calculateFighterRecord(fighter2, data);
            document.getElementById('redFighterAge'       ).textContent = redFighterInfo.age;
            document.getElementById('blueFighterAge'      ).textContent = blueFighterInfo.age;
            document.getElementById('redFighterHeight'    ).textContent = redFighterInfo.height;
            document.getElementById('blueFighterHeight'   ).textContent = blueFighterInfo.height;
            document.getElementById('redFighterReach'     ).textContent = redFighterInfo.reach;
            document.getElementById('blueFighterReach'    ).textContent = blueFighterInfo.reach;
            document.getElementById('redFighterStance'    ).textContent = redFighterInfo.stance;
            document.getElementById('blueFighterStance'   ).textContent = blueFighterInfo.stance;

            const fighter1Opponents = data.filter(row => row['Red Fighter'] === fighter1 || row['Blue Fighter'] === fighter1).slice(-3).reverse();
            const fighter2Opponents = data.filter(row => row['Red Fighter'] === fighter2 || row['Blue Fighter'] === fighter2).slice(-3).reverse();
            for (let i = 0; i < 3; i++) {
                let fighter1Opponent = '';
                let fighter2Opponent = '';
                if (fighter1Opponents[i]) {
                    const isRedFighter = fighter1Opponents[i]['Red Fighter'] === fighter1;
                    fighter1Opponent = isRedFighter ? fighter1Opponents[i]['Blue Fighter'] : fighter1Opponents[i]['Red Fighter'];
                    const result = getFightResult(fighter1, fighter1Opponents[i]['Red Result'], fighter1Opponents[i]['Blue Result'], isRedFighter);
                    let details = fighter1Opponents[i]['Details'];
                    if (fighter1Opponents[i]['Method'].includes('Decision') && details) {details = formatDecisionScores(details);}
                    document.getElementById(`redFighterOpponent${i+1}`).innerHTML = `${fighter1Opponent} <span style="color:${result.color};">${result.text}</span><br><span>Round ${fighter1Opponents[i]['Round']} at ${fighter1Opponents[i]['Time']} ${fighter1Opponents[i]['Method']}${details ? `<br>${details}` : ''}</span>`;
                };
                if (fighter2Opponents[i]) {
                    const isRedFighter = fighter2Opponents[i]['Red Fighter'] === fighter2;
                    fighter2Opponent = isRedFighter ? fighter2Opponents[i]['Blue Fighter'] : fighter2Opponents[i]['Red Fighter'];
                    const result = getFightResult(fighter2, fighter2Opponents[i]['Red Result'], fighter2Opponents[i]['Blue Result'], isRedFighter);
                    let details = fighter2Opponents[i]['Details'];
                    if (fighter2Opponents[i]['Method'].includes('Decision') && details) {details = formatDecisionScores(details);}
                    document.getElementById(`blueFighterOpponent${i+1}`).innerHTML = `${fighter2Opponent} <span style="color:${result.color};">${result.text}</span><br><span>Round ${fighter2Opponents[i]['Round']} at ${fighter2Opponents[i]['Time']} ${fighter2Opponents[i]['Method']}${details ? `<br>${details}` : ''}</span>`;
                };
            };

            //---Update Stats Table Elements---//
            const metrics = [
                { id: 'redFighterAverageControlTime', key: 'Average Control Ratio Post' },
                { id: 'blueFighterAverageControlTime', key: 'Average Control Ratio Post' },
                { id: 'redFighterAverageControlledTime', key: 'Average Controlled Ratio Post' },
                { id: 'blueFighterAverageControlledTime', key: 'Average Controlled Ratio Post' },
                { id: 'redFighterAverageTakedownVolume', key: 'Average Takedown Volume Post' },
                { id: 'blueFighterAverageTakedownVolume', key: 'Average Takedown Volume Post' },
                { id: 'redFighterAverageTakedownAccuracy', key: 'Average Takedowns Accuracy Post' },
                { id: 'blueFighterAverageTakedownAccuracy', key: 'Average Takedowns Accuracy Post' },
                { id: 'redFighterAverageTakedownDefense', key: 'Average Takedowns Defense Post' },
                { id: 'blueFighterAverageTakedownDefense', key: 'Average Takedowns Defense Post' },
                { id: 'redFighterAverageDistanceStrikeVolume', key: 'Average Distance Strike Volume Post' },
                { id: 'blueFighterAverageDistanceStrikeVolume', key: 'Average Distance Strike Volume Post' },
                { id: 'redFighterAverageDistanceStrikeAccuracy', key: 'Average Distance Strike Accuracy Post' },
                { id: 'blueFighterAverageDistanceStrikeAccuracy', key: 'Average Distance Strike Accuracy Post' },
                { id: 'redFighterAverageDistanceStrikeDefense', key: 'Average Distance Strike Defense Post' },
                { id: 'blueFighterAverageDistanceStrikeDefense', key: 'Average Distance Strike Defense Post' },
                { id: 'redFighterCareerKnockdowns', key: 'Career Knockdowns Post' },
                { id: 'blueFighterCareerKnockdowns', key: 'Career Knockdowns Post' },
                { id: 'redFighterCareerKnockouts', key: 'Career Knockouts Post' },
                { id: 'blueFighterCareerKnockouts', key: 'Career Knockouts Post' },
                { id: 'redFighterCareerKnocked-downs', key: 'Career Knocked-downs Post' },
                { id: 'blueFighterCareerKnocked-downs', key: 'Career Knocked-downs Post' },
                { id: 'redFighterCareerKnocked-outs', key: 'Career Knocked-outs Post' },
                { id: 'blueFighterCareerKnocked-outs', key: 'Career Knocked-outs Post' },
                { id: 'redFighterCareerSubmissions', key: 'Career Submissions Post' },
                { id: 'blueFighterCareerSubmissions', key: 'Career Submissions Post' },
                { id: 'redFighterCareerSubmitteds', key: 'Career Submitteds Post' },
                { id: 'blueFighterCareerSubmitteds', key: 'Career Submitteds Post' }
            ];
            const rounds = ['', 'Round 1', 'Round 2', 'Round 3', 'Round 4', 'Round 5'];
            rounds.forEach(round => {
                const roundSuffix = round ? ` ${round}` : '';
                metrics.forEach(({ id, key }) => {
                    const roundId = id + (round ? round.replace(' ', '') : '');
                    const roundKey = key.replace(' Post', `${roundSuffix} Post`);
                    value = '';
                    document.getElementById(roundId).innerHTML = `<span style="color:${id.startsWith('red') ? 'rgb(220, 20, 60)' : 'rgb(65, 105, 225)'};">${value}</span>`;
                })
            });
            rounds.forEach(round => {
                const roundSuffix = round ? ` ${round}` : '';
                metrics.forEach(({ id, key }) => {
                    const roundId = id + (round ? round.replace(' ', '') : '');
                    const roundKey = key.replace(' Post', `${roundSuffix} Post`);
                    let fighterData, isRedFighter, opponentKey;
                    if (id.startsWith('red')) {
                        fighterData = fighter1Data[fighter1Data.length - 1];
                        isRedFighter = fighterData && fighterData['Red Fighter'] === fighter1;
                    } else {
                        fighterData = fighter2Data[fighter2Data.length - 1];
                        isRedFighter = fighterData && fighterData['Red Fighter'] === fighter2;
                    }
                    if (fighterData) {
                        opponentKey = isRedFighter ? `Red ${roundKey}` : `Blue ${roundKey}`;
                        let value = fighterData[opponentKey];
                        if (roundId.includes('Time')) {
                            value = convertSecondsToMinutes(value);
                        } else if (!roundId.includes('Career')) {
                            if (value >= 10) {
                                value = Math.round(value);
                            } else {
                                const precision = 2;
                                const scale = Math.pow(10, Math.floor(Math.log10(Math.abs(value))) + 1 - precision);
                                value = Math.round(value / scale) * scale;
                                value = parseFloat(value.toPrecision(2));
                            }
                        }
                        if ((value === undefined || value === null || (isNaN(value)) && !String(value).includes(':'))) {
                            value = '';
                        }
                        document.getElementById(roundId).innerHTML = `<span style="color:${id.startsWith('red') ? 'rgb(220, 20, 60)' : 'rgb(65, 105, 225)'};">${value}</span>`;
                    }
                });
            });


            //---Update Radar Chart Data---//
            const radarCanvas = document.getElementById('radarChart');
            const radarChart  = Chart.getChart(radarCanvas);
            radarChart.data.datasets[0].data  = radarDataFighter1;
            radarChart.data.datasets[0].label = fighter1;
            radarChart.data.datasets[1].data  = radarDataFighter2;
            radarChart.data.datasets[1].label = fighter2;
            radarChart.update();

            //---Update Line Graph Data---//
            const lineCanvas = document.getElementById('lineGraph');
            const lineChart  = Chart.getChart(lineCanvas);
            lineChart.data.datasets[0].label = fighter1;
            lineChart.data.datasets[1].label = fighter2;
            window.myLineChart.options.scales.y.title.text = metric;
            const fightersData = [
                {
                    values: valuesFighter1,
                    opponents: opponentsFighter1,
                    events: eventsFighter1,
                    dates: datesFighter1,
                    locations: locationsFighter1,
                    weights: weightsFighter1,
                    referees: refereesFighter1,
                    rounds: roundsFighter1,
                    times: timesFighter1,
                    methods: methodsFighter1
                },
                {
                    values: valuesFighter2,
                    opponents: opponentsFighter2,
                    events: eventsFighter2,
                    dates: datesFighter2,
                    locations: locationsFighter2,
                    weights: weightsFighter2,
                    referees: refereesFighter2,
                    rounds: roundsFighter2,
                    times: timesFighter2,
                    methods: methodsFighter2
                }
            ];
            fightersData.forEach((fighterData, i) => {
                window.myLineChart.data.datasets[i].data = fighterData.values.map((value, index) => ({
                    x: index,
                    y: value,
                    opponent: fighterData.opponents[index],
                    event: fighterData.events[index],
                    date: fighterData.dates[index],
                    location: fighterData.locations[index],
                    weight: fighterData.weights[index],
                    referee: fighterData.referees[index],
                    round: fighterData.rounds[index],
                    time: fighterData.times[index],
                    method: fighterData.methods[index]
                }));
                window.myLineChart.data.datasets[i].pointStyle = fighterData.methods.map(method => getPointStyle(method));
                window.myLineChart.data.datasets[i].pointRadius = fighterData.methods.map(method => getPointRadius(method));
            });
            window.myLineChart.update();

        }

        function calculateFighterRecord(fighter, data) {
            let wins = 0, losses = 0, draws = 0, noContests = 0;

            data.forEach(fight => {
                if (fight['Red Fighter'] === fighter || fight['Blue Fighter'] === fighter) {
                    const isRed = fight['Red Fighter'] === fighter;
                    const redResult = fight['Red Result'];
                    const blueResult = fight['Blue Result'];

                    if (isRed) {
                        if (redResult == 1) wins++;
                        else if (redResult == 0 && blueResult == 1) losses++;
                        else if (redResult == 0 && blueResult == 0) noContests++;
                        else if (redResult == 0.5) draws++;
                    } else {
                        if (blueResult == 1) wins++;
                        else if (blueResult == 0 && redResult == 1) losses++;
                        else if (blueResult == 0 && redResult == 0) noContests++;
                        else if (blueResult == 0.5) draws++;
                    }
                }
            });
            return `${wins}-${losses}-${draws}&nbsp;&nbsp;&nbsp;${noContests} NC`;
        };

        function getFighterInfo(name, fighterInfo) {
            const fighter = fighterInfo.find(f => f['Full Name'] === name);
            if (!fighter) return { age: 'Unknown', height: 'Unknown', reach: 'Unknown', stance: 'Unknown' };

            const height = fighter['Height'] || 'Unknown';
            const reach = fighter['Reach'] || 'Unknown';
            const stance = fighter['Stance'] || 'Unknown';
            const dob = fighter['Date of Birth'] ? fighter['Date of Birth'].trim() : null;
            const age = dob ? calculateAge(dob) : 'Unknown';

            return { age, height, reach, stance };
        }

        function calculateAge(dob) {
            const birthDate = new Date(dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function getFightResult(fighter, redResult, blueResult, isRed) {
            if (isRed) {
                if (redResult == 1) return { text: 'W', color: 'green' };
                if (redResult == 0 && blueResult == 1) return { text: 'L', color: 'red' };
                if (redResult == 0 && blueResult == 0) return { text: 'NC', color: 'gray' };
                if (redResult == 0.5) return { text: 'D', color: 'yellow' };
            } else {
                if (blueResult == 1) return { text: 'W', color: 'green' };
                if (blueResult == 0 && redResult == 1) return { text: 'L', color: 'red' };
                if (blueResult == 0 && redResult == 0) return { text: 'NC', color: 'gray' };
                if (blueResult == 0.5) return { text: 'D', color: 'yellow' };
            }
            return { text: '-', color: 'black' };
        }

        function formatDecisionScores(details) {
            const scores = details.match(/\d+\s*-\s*\d+/g);
            return scores ? scores.join(' | ') : details;
        }

        function convertSecondsToMinutes(seconds) {
            seconds = Math.floor(seconds);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const formattedSeconds = remainingSeconds.toString().padStart(2, '0');
            return `${minutes}:${formattedSeconds}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById("myModal");
            const openModalBtn = document.getElementById("nextEventBtn");
            const closeModalSpan = document.querySelector(".close");
            const cancelButton = document.getElementById("cancelButton");
            openModalBtn.addEventListener("click", () => {
                modal.style.display = "block";
            });
            closeModalSpan.onclick = cancelButton.onclick = () => {
                modal.style.display = "none";
            };
            window.onclick = (event) => {
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            };
            const fightButtons = document.querySelectorAll('#myModal button[id^="fight"]');
            fightButtons.forEach(button => {
                button.onclick = function () {
                    const fighters = this.textContent.split(' vs. ');
                    if (fighters.length === 2) {
                        document.getElementById('redDropbtn').textContent = fighters[0].trim();
                        document.getElementById('blueDropbtn').textContent = fighters[1].trim();
                        updateChart();
                    }
                    modal.style.display = "none";
                };
            });
        });

        document.getElementById("captureButton").addEventListener("click", () => {

            const gridContainer = document.querySelector(".grid-container");
            const originalStyles = gridContainer.style.cssText; // Save original styles

            html2canvas(gridContainer, { 
                scale: 1,
                width: gridContainer.offsetWidth,
                height: gridContainer.offsetHeight,
                backgroundColor: "rgba(30,30,30,1)"
            }).then((canvas) => {
                gridContainer.style.cssText = originalStyles; // Restore styles
                canvas.toBlob((blob) => {
                    if (!blob) {
                        console.error("Failed to create image blob.");
                        return;
                    }
                    const item = new ClipboardItem({ "image/png": blob });
                    navigator.clipboard.write([item]).then(() => {
                        showNotification("Image copied to clipboard!");
                    }).catch((err) => {
                        console.error("Failed to copy to clipboard: ", err);
                    });
                });
            }).catch((err) => {
                console.error("Failed to capture grid container: ", err);
                gridContainer.style.cssText = originalStyles; // Ensure styles are restored
            });
            
        });

        document.getElementById("downloadButton").addEventListener("click", () => {
            const gridContainer = document.querySelector(".grid-container");
            const originalStyles = gridContainer.style.cssText; // Save original styles

            html2canvas(gridContainer, {
                scale: 1,
                width: gridContainer.offsetWidth,
                height: gridContainer.offsetHeight,
                backgroundColor: "rgba(30,30,30,1)"
            }).then((canvas) => {
                gridContainer.style.cssText = originalStyles; // Restore styles
                canvas.toBlob((blob) => {
                    if (!blob) {
                        console.error("Failed to create image blob.");
                        return;
                    }
                    // Create a download link
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = "OpenDynaMathup.png"; // Set the filename
                    document.body.appendChild(link); // Append the link to the body
                    link.click(); // Trigger the download
                    document.body.removeChild(link); // Clean up
                    URL.revokeObjectURL(link.href); // Release the object URL
                });
            }).catch((err) => {
                console.error("Failed to capture grid container: ", err);
                gridContainer.style.cssText = originalStyles; // Ensure styles are restored
            });
        });

        function showNotification(message) {
            const notification = document.getElementById("copyNotification");
            notification.textContent = message;
            notification.style.display = "block";
            notification.style.opacity = "1";
            setTimeout(() => {
                notification.style.opacity = "0";
                setTimeout(() => {
                    notification.style.display = "none";
                }, 500);
            }, 500);
        }

        function updateFontSizesBasedOnAspectRatio() {
            const aspectRatio = window.innerWidth / window.innerHeight;
            const isMobile = aspectRatio < 1;
            const fontSizeMultiplier = isMobile ? 2 : 1;
            const markerSizeMultiplier = isMobile ? 2 : 1;
            window.myRadarChart.options.scales.r.pointLabels.font.size = 18 * fontSizeMultiplier;
            window.myRadarChart.options.scales.r.ticks.font.size = 16 * fontSizeMultiplier;
            window.myRadarChart.options.plugins.legend.labels.font.size = 16 * fontSizeMultiplier;
            window.myRadarChart.data.datasets.forEach(dataset => {
                dataset.pointRadius = 6 * markerSizeMultiplier;
                dataset.pointHoverRadius = 8 * markerSizeMultiplier;
            });
            window.myLineChart.options.scales.x.title.font.size = 18 * fontSizeMultiplier;
            window.myLineChart.options.scales.x.ticks.font.size = 16 * fontSizeMultiplier;
            window.myLineChart.options.scales.y.title.font.size = 18 * fontSizeMultiplier;
            window.myLineChart.options.scales.y.ticks.font.size = 16 * fontSizeMultiplier;
            window.myLineChart.options.plugins.legend.labels.font.size = 16 * fontSizeMultiplier;
            window.myLineChart.data.datasets.forEach(dataset => {
                dataset.pointRadius = 6 * markerSizeMultiplier;
                dataset.pointHoverRadius = 8 * markerSizeMultiplier;
            });
            window.myLineChart.options.plugins.tooltip.bodyFont.size = 24 * fontSizeMultiplier;
            window.myRadarChart.update();
            window.myLineChart.update();
        }

        function setInitialFightersFromModal() {
            const firstBoutButton = document.querySelector('#myModal button[id^="fight"]');
            if (firstBoutButton) {
                const fighters = firstBoutButton.textContent.split(' vs. ');
                if (fighters.length === 2) {
                    const [fighter1, fighter2] = fighters.map(f => f.trim());
                    document.getElementById('redDropbtn').textContent = fighter1;
                    document.getElementById('blueDropbtn').textContent = fighter2;
                    updateChart();
                }
            }
        }

        window.addEventListener('resize', updateFontSizesBasedOnAspectRatio);

        updateFontSizesBasedOnAspectRatio();

        function showLeaderboard(metric) {
            const modalTitle = document.querySelector('#leaderboardModal h2');
            const currentHeader = document.getElementById('currentHeader');
            const careerMaxHeader = document.getElementById('careerMaxHeader');
            const selectedWeightClass = document.getElementById('weightClassSelect').value;
            const activeOnly = document.getElementById('activeFightersCheckbox').checked;

            // Update modal title based on the dropdown selection, in all caps
            modalTitle.textContent = "OpenDyna UFC " + selectedWeightClass + " Rankings";
            currentHeader.textContent = `Current ${metric}`;
            careerMaxHeader.textContent = `Career Max ${metric}`;

            // Identify the last event
            const lastEventName = (function getLastEvent(data) {
                const eventsByDate = {};
                data.forEach(row => {
                    const eventName = row['Event Name'];
                    const date = new Date(row['Date']);
                    if (!eventsByDate[eventName] || date > eventsByDate[eventName]) {
                        eventsByDate[eventName] = date;
                    }
                });

                let lastEvent = null;
                let lastEventDate = new Date(0);
                for (let e in eventsByDate) {
                    if (eventsByDate[e] > lastEventDate) {
                        lastEventDate = eventsByDate[e];
                        lastEvent = e;
                    }
                }
                return lastEvent;
            })(data);

            // Pre-Final Rankings: usePreForLastEvent = true
            const preFinalRankings = calculateLeaderboard(metric, sortColumn, sortOrder, selectedWeightClass, activeOnly, true, lastEventName);
            // Post-Final Rankings: usePreForLastEvent = false
            const postFinalRankings = calculateLeaderboard(metric, sortColumn, sortOrder, selectedWeightClass, activeOnly, false, lastEventName);

            // Create a map of Pre-Final ranks
            const preFinalRankMap = {};
            preFinalRankings.forEach((fighter, index) => {
                preFinalRankMap[fighter.name] = index + 1; // ranks are 1-based
            });

            const leaderboardTableBody = document.getElementById('leaderboardTable').querySelector('tbody');
            leaderboardTableBody.innerHTML = ''; // Clear existing rows

            postFinalRankings.forEach((fighter, index) => {
                const currentRank = index + 1;
                const oldRank = preFinalRankMap[fighter.name];
                let rankChangeSymbol = '';

                if (oldRank !== undefined) {
                    const diff = oldRank - currentRank;
                    if (diff > 0) {
                        // Moved up
                        rankChangeSymbol = `<span style="color:green;">▲ +${diff}</span>`;
                    } else if (diff < 0) {
                        // Moved down
                        rankChangeSymbol = `<span style="color:red;">▼ ${diff}</span>`;
                    }
                    // If diff == 0, no change symbol
                } else {
                    // Fighter not in preFinalRankings (new entry)
                    rankChangeSymbol = `<span style="color:blue;">● NEW</span>`;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${currentRank}</td>
                    <td>${fighter.name} ${rankChangeSymbol}</td>
                    <td>${fighter.current.toFixed(2)}</td>
                    <td>${fighter.careerMax.toFixed(2)}</td>
                `;
                leaderboardTableBody.appendChild(row);
            });
        }


        function calculateLeaderboard(metric, sortColumn, sortOrder, weightClass, activeOnly, usePreForLastEvent, lastEventName) {
            const fighterStats = {};

            data.forEach(row => {
                const redFighter = row['Red Fighter'];
                const blueFighter = row['Blue Fighter'];
                const eventName = row['Event Name'];
                const date = new Date(row['Date']);
                const fightWeightClass = normalizeWeightClass(row['Weight'] ? row['Weight'].trim() : '');

                // Determine metric suffix based on whether this fight is in the last event and if we are using pre-final logic
                const metricSuffix = (usePreForLastEvent && eventName === lastEventName) ? 'Pre' : 'Post';

                const redScore = parseFloat(row[`Red ${metric} ${metricSuffix}`]) || 0;
                const blueScore = parseFloat(row[`Blue ${metric} ${metricSuffix}`]) || 0;

                const considerRed = redFighter && (!activeOnly || rost.has(redFighter));
                const considerBlue = blueFighter && (!activeOnly || rost.has(blueFighter));
                
                if (considerRed) {
                    if (!fighterStats[redFighter]) {
                        fighterStats[redFighter] = { 
                            name: redFighter, 
                            current: redScore, 
                            careerMax: redScore, 
                            date, 
                            weightClass: fightWeightClass
                        };
                    } else {
                        fighterStats[redFighter].careerMax = Math.max(fighterStats[redFighter].careerMax, redScore);
                        if (date > fighterStats[redFighter].date) {
                            fighterStats[redFighter].current = redScore;
                            fighterStats[redFighter].date = date;
                            fighterStats[redFighter].weightClass = fightWeightClass;
                        }
                    }
                }

                if (considerBlue) {
                    if (!fighterStats[blueFighter]) {
                        fighterStats[blueFighter] = { 
                            name: blueFighter, 
                            current: blueScore, 
                            careerMax: blueScore, 
                            date, 
                            weightClass: fightWeightClass
                        };
                    } else {
                        fighterStats[blueFighter].careerMax = Math.max(fighterStats[blueFighter].careerMax, blueScore);
                        if (date > fighterStats[blueFighter].date) {
                            fighterStats[blueFighter].current = blueScore;
                            fighterStats[blueFighter].date = date;
                            fighterStats[blueFighter].weightClass = fightWeightClass;
                        }
                    }
                }
            });

            let sortedStats = Object.values(fighterStats);

            const p4pClasses = [
                "Flyweight", "Bantamweight", "Featherweight",
                "Lightweight", "Welterweight", "Middleweight",
                "Light Heavyweight", "Heavyweight"
            ];

            const wp4pClasses = [
                "Women's Strawweight",
                "Women's Flyweight",
                "Women's Bantamweight"
            ];

            if (weightClass === "Pound-for-Pound") {
                sortedStats = sortedStats.filter(fighter => p4pClasses.includes(fighter.weightClass));
            } else if (weightClass === "Women's Pound-for-Pound") {
                sortedStats = sortedStats.filter(fighter => wp4pClasses.includes(fighter.weightClass));
            } else if (weightClass !== "Pound-for-Pound" && weightClass !== "Women's Pound-for-Pound") {
                sortedStats = sortedStats.filter(fighter => fighter.weightClass === weightClass);
            }

            sortedStats.sort((a, b) => {
                const comparison = a[sortColumn] - b[sortColumn];
                return sortOrder === 'asc' ? comparison : -comparison;
            });

            return sortedStats;

        }


        document.getElementById('showLeaderboardBtn').addEventListener('click', () => {
            const metric = document.getElementById('metricDropbtn').textContent.trim();
            document.getElementById('leaderboardModal').style.display = 'block';
            showLeaderboard(metric);
        });

        document.getElementById('closeLeaderboard').addEventListener('click', () => {
            document.getElementById('leaderboardModal').style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            const modal = document.getElementById('leaderboardModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });

        document.getElementById('currentHeader').addEventListener('click', () => {
            toggleSort('current');
        });

        document.getElementById('careerMaxHeader').addEventListener('click', () => {
            toggleSort('careerMax');
        });

        function toggleSort(column) {
            if (sortColumn === column) {
                // If the column is already selected, toggle the sort order
                sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                // Otherwise, change the column and reset to descending order
                sortColumn = column;
                sortOrder = 'desc';
            }

            const metric = document.getElementById('metricDropbtn').textContent;
            showLeaderboard(metric);
        }

        function normalizeWeightClass(rawClass) {
            if (!rawClass) return '';

            // Remove leading "UFC " (case-insensitive)
            let normalized = rawClass.replace(/^UFC\s+/i, '');

            // Remove leading "Interim " (case-insensitive)
            normalized = normalized.replace(/^Interim\s+/i, '');

            // Remove trailing " Title" (case-insensitive)
            normalized = normalized.replace(/\s+Title$/i, '');

            return normalized.trim();
        }

        document.getElementById('weightClassSelect').addEventListener('change', () => {
            const metric = document.getElementById('metricDropbtn').textContent.trim();
            showLeaderboard(metric);
        });

        document.getElementById('activeFightersCheckbox').addEventListener('change', () => {
            const metric = document.getElementById('metricDropbtn').textContent.trim();
            showLeaderboard(metric);
        });

    </script>
</body>
</html>
